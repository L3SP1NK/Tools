#!/bin/bash
## Friendly frequency monitor.

cpu_name=$(lscpu|grep "Model name"|cut -d ":" -f 2|sed 's/  //g;s/^ //g'|awk '{print $1,$2}')

## hack for only 1
cpu_device_path="/sys/devices/system/cpu/cpu*/cpufreq"
scaling_governor=$(cat $cpu_device_path/scaling_governor|sort -u)
scaling_driver=$(cat $cpu_device_path/scaling_driver|sort -u)

	case $scaling_governor in
		'schedutil')
			scaling_governor_icon='ğŸ’¡';;
		'performance')
			scaling_governor_icon='ğŸ”Œ';;
		'powersave')
			scaling_governor_icon='ğŸ”‹';;
		'ondemand')
			scaling_governor_icon='ğŸš ';;
		'conservative')
			scaling_governor_icon='ğŸ› ';;
	esac

#echo -e " \e[2m\e[4m$cpu_name\e[0m"
echo -e "\e[1m $scaling_driver: $scaling_governor$scaling_governor_icon \e[0m"

## end hack

core_num=$(nproc)
_core_num=$((core_num - 1))

for ((core=0; core<=_core_num; core++)); do

	cpu_device_path="/sys/devices/system/cpu/cpu$core/cpufreq"
	scaling_cur_freq=$(cat $cpu_device_path/scaling_cur_freq)
#	scaling_governor=$(cat $cpu_device_path/scaling_governor)
#
#	case $scaling_governor in
#		'schedutil')
#			scaling_governor_icon='ğŸ’¡';;
#		'performance')
#			scaling_governor_icon='ğŸ”Œ';;
#		'powersave')
#			scaling_governor_icon='ğŸ”‹';;
#		'ondemand')
#			scaling_governor_icon='ğŸš ';;
#		'conservative')
#			scaling_governor_icon='ğŸ› ';;
#	esac

	scaling_max_freq=$(cat $cpu_device_path/scaling_max_freq)

	bc_scale=2
    freq_ghz=$(echo "scale=$bc_scale; $scaling_cur_freq / 1000000" | bc)
    scaling_ratio=$(echo "scale=$bc_scale; $scaling_cur_freq / $scaling_max_freq" | bc)

	## add leading 0 if <1
	[[ "${scaling_ratio:0:1}" == '.' ]] && scaling_ratio="0$scaling_ratio"

	# get around bash floating limitation
	scaled_ratio=$(echo "$scaling_ratio * 100" | bc)
	_scaled_ratio=$(echo $scaled_ratio | cut -d '.' -f 1)

	case 1 in
		$((_scaled_ratio > 101)) )
			color="\e[35m"; icon="ğŸ¦„";;

		$((_scaled_ratio >= 90)) )
			color="\e[31m"; icon="ğŸ†";;

		$((_scaled_ratio >= 60)) )
			color="\e[33m"; icon="ğŸ‡";;

		$((_scaled_ratio >= 50)) )
			color="\e[32m"; icon="ğŸ¢";;

		$((_scaled_ratio >= 30)) )
			color="\e[37m"; icon="ğŸŒ";;
		*)
			color_icon="\e[38m ?";;
	esac

	_core=$(( core + 1  ))
#	echo -e "$color $scaling_governor_icon core$_core -\e[2m [$scaling_governor]\e[0m$color - $freq_ghz GHz - \e[2m($scaling_ratio)\e[0m"
	echo -e " Â» $icon core$_core:$color $freq_ghz GHz \e[2m($scaling_ratio)\e[0m"

done

