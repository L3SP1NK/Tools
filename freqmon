#!/bin/bash
## Friendly frequency monitor.

cpu_name=$(lscpu|grep "Model name"|cut -d ":" -f 2)
_cpu_name=${cpu_name//  /}

echo -e "\n \e[4m$_cpu_name:\e[0m\n"

core_num=$(nproc)
_core_num=$((core_num - 1))

for ((core=0; core<=_core_num; core++)); do

	cpu_device_path="/sys/devices/system/cpu/cpu$core/cpufreq"

    scaling_cur_freq=$(cat $cpu_device_path/scaling_cur_freq)
	scaling_governor=$(cat $cpu_device_path/scaling_governor)

	case $scaling_governor in
		'schedutil')
			scaling_governor_icon='üí°';;
		'performance')
			scaling_governor_icon='üîå';;
		'powersave')
			scaling_governor_icon='üîã';;
		'ondemand')
			scaling_governor_icon='üéö ';;
		'conservative')
			scaling_governor_icon='üéõ ';;
	esac

	scaling_max_freq=$(cat $cpu_device_path/scaling_max_freq)

	bc_scale=2
    freq_ghz=$(echo "scale=$bc_scale; $scaling_cur_freq / 1000000" | bc)
    scaling_ratio=$(echo "scale=$bc_scale; $scaling_cur_freq / $scaling_max_freq" | bc)

	## add leading 0 if <1
	[[ "${scaling_ratio:0:1}" == '.' ]] && scaling_ratio="0$scaling_ratio"

	# get around bash floating limitation
	scaled_ratio=$(echo "$scaling_ratio * 100" | bc)
	_scaled_ratio=$(echo $scaled_ratio | cut -d '.' -f 1)

	case 1 in
		$((_scaled_ratio > 100)) )
			color="\e[35m"; icon="ü¶Ñ";;

		$((_scaled_ratio >= 80)) )
			color="\e[31m"; icon="üêÜ";;

		$((_scaled_ratio >= 70)) )
			color="\e[33m"; icon="üêá";;

		$((_scaled_ratio >= 50)) )
			color="\e[32m"; icon="üê¢";;

		$((_scaled_ratio >= 30)) )
			color="\e[37m"; icon="üêå";;
		*)
			color_icon="\e[38m ?";;
	esac

	echo -e "$color $scaling_governor_icon core$core -\e[2m [$scaling_governor]\e[0m$color - $freq_ghz GHz - \e[2m($scaling_ratio)\e[0m"

done

