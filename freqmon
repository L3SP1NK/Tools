#!/bin/bash

get_max_freq() {
    local max_freq=0
    for core in $(seq 0 $(( $(nproc) - 1 )) ); do
        freq=$(cat /sys/devices/system/cpu/cpu$core/cpufreq/scaling_max_freq 2>/dev/null || echo 0)
        if (( freq > max_freq )); then
            max_freq=$freq
        fi
    done
    echo $max_freq


}

max_freq=$(get_max_freq)
max_freq_ghz=$(echo "scale=2; $max_freq / 1000000" | bc)

get_color_and_emoji() {
    local ratio=$1
    case 1 in
        $(echo "$ratio > 1.05" | bc -l))	## Using weird ratio value here rather than
            echo -e "\e[35mü¶Ñ"				## .25, .5, .75, 1 cause it make more sense.
            ;;								## Depends on CPU model, adjust accordingly
        $(echo "$ratio >= 0.95" | bc -l))	## Or divide max_freq by X.
            echo -e "\e[31müêÜ"
            ;;
        $(echo "$ratio >= 0.8" | bc -l))
            echo -e "\e[33müêá"
            ;;
        $(echo "$ratio >= 0.4" | bc -l))
            echo -e "\e[32müê¢"
            ;;
        $(echo "$ratio >= 0.25" | bc -l))
            echo -e "\e[32müêå"
            ;;
        *)
            echo -e "\e[38mÛ∞ÇÉ"
            ;;
    esac
}

cgov=$(cpufreq-info |grep "The gov"|awk -F'[""]' '{print $2}'|sort -u)
echo -e " \e[1m\e[4mCPU Frequency ($cgov):\e[0m"

# Iterate over each CPU
for core in $(seq 0 $(( $(nproc) - 1 )) ); do
    freq=$(cat /sys/devices/system/cpu/cpu$core/cpufreq/scaling_cur_freq 2>/dev/null || echo 0)
    freq_ghz=$(echo "scale=2; $freq / 1000000" | bc)
    ratio=$(echo "scale=2; $freq / $max_freq" | bc)
    color_and_emoji=$(get_color_and_emoji $ratio)

	[[ "${ratio:0:1}" == '.' ]] && ratio="0${ratio}"

	rcore=$(( core + 1 ))
	cgov=$(cpufreq-info -c $core|grep "The gov"|awk -F'[""]' '{print $2}')

#      case $cgov in
#                'schedutil')
#                        gov_icon='üêÄ';;
#                'performance')
#                        gov_icon='üêÜ';;
#                'powersave')
#                        gov_icon='üêå';;
#                'ondemand')
#                        gov_icon='üêá';;
#                'conservative')
#                        gov_icon='üê¢';;
#        esac
#
#	echo -e "  core $rcore: ${color_and_emoji} $freq_ghz GHz ($ratio) [$gov_icon $cgov]\033[0m"
	echo -e "  core $rcore: ${color_and_emoji} $freq_ghz GHz ($ratio)\033[0m"
done
